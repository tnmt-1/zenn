---
title: "AWS Bedrockã§å›ç­”ã®ç¶šãã‚’å–å¾—ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ’­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "bedrock", "python", "anthropic"]
published: true
---

## æ–¹æ³•

- `invoke_model`ã‚’ä½¿ã„ã¾ã™ã€‚
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ `"stop_reason": "max_tokens"` ã®ã¨ãã€`messages` ã« `{"role": "assistant", "content": [{"type": "text", "text": {ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ}}]`ã‚’è¿½åŠ ã—ã¦ã€å†åº¦`invoke_model`ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ `"stop_reason": "end_turn"` ã«ãªã‚‹ã¾ã§ç¶šã‘ã¾ã™ã€‚

## ç’°å¢ƒ

- Python 3
- boto3
- ãƒ¢ãƒ‡ãƒ«: Claude 3 Haiku

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

`max_tokens` ã§æ‰“ã¡åˆ‡ã‚‰ã‚Œã‚‹ãŸã³ã«å¿œç­”ã‚’å†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã€ç”Ÿæˆã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’é€£çµã—ã¦ã„ã¾ã™ã€‚`stop_reason` ãŒ `"end_turn"` ã«ãªã‚‹ã¾ã§ã“ã‚Œã‚’ç¹°ã‚Šè¿”ã™ä»•çµ„ã¿ã§ã™ã€‚

```python
#!/usr/bin/env python
import json

import boto3

client = boto3.client("bedrock-runtime")
model_id = "anthropic.claude-3-haiku-20240307-v1:0"


def main() -> str:
    full_text = ""
    body_params = {
        "anthropic_version": "bedrock-2023-05-31",
        "max_tokens": 10,   # æ„å›³çš„ã«å°ã•ã„å€¤ã«ã—ã¦ã„ã¾ã™
        "messages": [
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": "ã‚«ã‚¨ãƒ«ã«ã¤ã„ã¦ã®ä¿³å¥ã‚’ä½œã£ã¦ãã ã•ã„"},
                ],
            },
        ],
    }

    while True:
        params = {
            "modelId": model_id,
            "body": json.dumps(body_params),
            "accept": "application/json",
            "contentType": "application/json",
        }

        print("Invoking model...")
        response = client.invoke_model(**params)
        response_body = json.loads(response.get("body").read())

        for content in response_body.get("content", []):
            full_text += content["text"].strip()

        stop_reason = response_body["stop_reason"]
        print("Stop reason: ", stop_reason)
        if stop_reason != "max_tokens":
            break

        body_params["messages"].append(
            {
                "role": "assistant",
                "content": [{"type": "text", "text": full_text}],
            },
        )

    return full_text


if __name__ == "__main__":
    generated_text = main()

    print("--------------------------")
    print(generated_text)
```

### å®Ÿè¡Œçµæœä¾‹

```txt
Invoking model...
Stop reason:  max_tokens
Invoking model...
Stop reason:  max_tokens
Invoking model...
Stop reason:  max_tokens
Invoking model...
Stop reason:  max_tokens
Invoking model...
Stop reason:  max_tokens
Invoking model...
Stop reason:  max_tokens
Invoking model...
Stop reason:  max_tokens
Invoking model...
Stop reason:  max_tokens
Invoking model...
Stop reason:  max_tokens
Invoking model...
Stop reason:  end_turn
--------------------------
ã¯ã„ã€ã‚«ã‚¨ãƒ«ã«ã¤ã„ã¦ã®ä¿³å¥ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

æ± ã®ã»ã¨ã‚Šã§
é™ã‹ã«é³´ãå°ã•ãªå£°å¤•æš®ã‚Œã®å½±è‡ªç„¶ã®ä¸­ã§ã®ã‚«ã‚¨ãƒ«ã€‚é™ã‹ã«éŸ¿ãå£°ã€ãã—ã¦å¤•æš®ã‚Œã®é™ã‘ã•ã‚’æ„Ÿã˜ã•ã›ã¦ãã‚Œã¾ã™ã€‚
```

## Converse API ã§ã¯ã§ããªã„ï¼Ÿ

Converse API ã§åŒã˜ã‚ˆã†ã«å›ç­”ã®ç¶šãã‚’å–å¾—ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€ä»¥ä¸‹ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

> botocore.errorfactory.ValidationException: An error occurred (ValidationException) when calling the Converse operation: A conversation must alternate between user and assistant roles. Make sure the conversation alternates between user and assistant roles and try again.

å›ç­”ã®ç¶šãã‚’å¾—ã‚ˆã†ã¨è©¦è¡ŒéŒ¯èª¤ã—ã¾ã—ãŸãŒã€ä¸Šæ‰‹ãã„ã‹ãšä¸Šè¨˜æ–¹æ³•ã«è½ã¡ç€ãã¾ã—ãŸã€‚

Converse API ã¯ä¾¿åˆ©ãªã®ã§èé€šãŒåˆ©ãã¨ã•ã‚‰ã«å¬‰ã—ã„ã§ã™ã­ã€‚
