---
title: "AWS Step Functionsã§ã‚¹ãƒ†ãƒ¼ãƒˆé–“ã®å¤‰æ•°ã‚’å…±æœ‰ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["aws", "stepfunctions"]
published: true
---

AWS Step Functionsã‚’ä½¿ç”¨ã™ã‚‹éš›ã€ã‚¹ãƒ†ãƒ¼ãƒˆé–“ã§å¤‰æ•°ã‚’å…±æœ‰ã—ãŸã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚Step Functionsã®`Assign`ã‚’ä½¿ç”¨ã—ã¦ã€ã‚ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆã®å®Ÿè¡Œçµæœã‚’åˆ¥ã®ã‚¹ãƒ†ãƒ¼ãƒˆã§å‚ç…§ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ã€UUIDã‚’ç”Ÿæˆã™ã‚‹Lambdaé–¢æ•°ã‚’2å›å®Ÿè¡Œã—ã€ãã‚Œãã‚Œã®çµæœã‚’çµ„ã¿åˆã‚ã›ã¦æœ€çµ‚çš„ãªå‡ºåŠ›ã‚’ç”Ÿæˆã™ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚

## ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³

> [!NOTE]
> æ„å›³çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆå…¥ã‚Œã¦ã„ã¾ã™ãŒã€ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥ã‚Œã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```json
{
    "Comment": "A description of my state machine",
    "StartAt": "SampleFirstLambda",
    "QueryLanguage": "JSONata",
    "States": {
        "SampleFirstLambda": {
            "Type": "Task",

            // å®Ÿè¡Œã™ã‚‹Lambda
            "Resource": "arn:aws:lambda:ap-northeast-1:999999999999:function:test-for-statemachine:$LATEST",

            // Lambdaã«æ¸¡ã™å¼•æ•°
            // ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ $state.input ã§å–å¾—å¯èƒ½
            "Arguments": {
                "sampleParam1": "{% $states.input.sampleParam1 %}"
            },

            // Lambdaã®å®Ÿè¡Œçµæœ
            // $state.result ã§å–å¾—å¯èƒ½
            "Output": {
                "sampleParam1": "{% $states.input.sampleParam1 %}",
                "sampleParam2": "{% $states.input.sampleParam2 %}",
                "sampleResultId": "{% $states.result.hoge_id %}"
            },

            // ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å†…ã§æ‰±ã†å¤‰æ•°ã‚’å®šç¾©ã§ãã‚‹
            "Assign": {
                "sampleFirstResult": {
                    "sampleParam1": "{% $states.input.sampleParam1 %}",
                    "sampleParam2": "{% $states.input.sampleParam2 %}",
                    "sampleResultId": "{% $states.result.hoge_id %}"
                }
            },
            "Next": "SampleSecondLambda"
        },
        "SampleSecondLambda": {
            "Type": "Task",
            "Resource": "arn:aws:lambda:ap-northeast-1:999999999999:function:test-for-statemachine:$LATEST",
            "Arguments": {
                "sampleParam1": "{% $states.input.sampleParam1 %}",
                "sampleParam2": "{% $states.input.sampleParam2 %}"
            },
            "Output": {
                "sampleParam1": "{% $states.input.sampleParam1 %}",
                
                // Assign ã§å®šç¾©ã—ãŸå¤‰æ•°ã‚’ä½¿ã£ã¦ã„ã‚‹
                "firstResultId": "{% $sampleFirstResult.sampleResultId %}",
                
                "secondResultId": "{% $states.result.hoge_id %}"
            },
            "End": true
        }
    }
}
```

## Lambda

UUIDã‚’ç”Ÿæˆã—ã¦è¿”ã™Lambdaã‚’ä½œæˆã—ã¾ã—ãŸã€‚

```py
import json
import uuid

def lambda_handler(event, context):
    event["hoge_id"] = str(uuid.uuid4())

    return event
```

## ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

```json
{
  "sampleParam1": "abc123",
  "sampleParam2": "xyz456"
}
```

## çµæœ

```json
{
  "sampleParam1": "abc123",
  "firstResultId": "0961c121-7907-43a5-94e4-3d483b5aa61f",
  "secondResultId": "07e04490-7aec-43f1-b86f-da859c04f93b"
}
```
